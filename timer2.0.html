<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interval Timer</title>
<style>
  :root{
    --rep-size: 14px;
    --rep-color: #888;
  }
  html,body{height:100%;}
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: white;
    transition: background-color 0.3s ease;
  }
  #container {
    text-align: center;
    position: relative;
    width: 560px;
    max-width: 90%;
  }
  #startBtn {
    padding: 12px 22px;
    font-size: 18px;
    cursor: pointer;
    border-radius: 8px;
    border: 1px solid #333;
    background: #fafafa;
  }
  #timerDisplay {
    font-size: 72px;
    margin-top: 18px;
    font-weight: bold;
    min-height: 88px;
  }
  #repCounter {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: var(--rep-size);
    color: var(--rep-color);
    font-weight: 400;
    background: rgba(255,255,255,0.7);
    padding: 6px 8px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }
  .visually-hidden{
    position:absolute!important;
    height:1px;width:1px;overflow:hidden;
    clip:rect(1px,1px,1px,1px);
    white-space:nowrap;
  }
</style>
</head>
<body>
<div id="container">
  <div id="repCounter" aria-live="polite"></div>
  <button id="startBtn">Start</button>
  <div id="timerDisplay" aria-live="assertive"></div>
</div>

<audio id="soundGreenToRed" src="green_to_red.mp3" preload="auto"></audio>
<audio id="soundRedToGreen" src="red_to_green.mp3" preload="auto"></audio>

<script>
  const startBtn = document.getElementById('startBtn');
  const timerDisplay = document.getElementById('timerDisplay');
  const repCounter = document.getElementById('repCounter');
  const soundGreenToRedElem = document.getElementById('soundGreenToRed');
  const soundRedToGreenElem = document.getElementById('soundRedToGreen');

  let running = false;
  let stopRequested = false;
  const maxReps = 60;

  let audioCtx = null;
  function ensureAudioContext(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    }
    return audioCtx;
  }

  function playBeep(freq=800, duration=120){
    const ctx = ensureAudioContext();
    if(!ctx) return Promise.resolve();
    const now = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + duration/1000);
    o.connect(g);
    g.connect(ctx.destination);
    o.start(now);
    o.stop(now + duration/1000 + 0.02);
    return new Promise(resolve => setTimeout(resolve, duration + 30));
  }

  async function playSoundElemOrBeep(elem, fallbackFreq){
    if(!elem) return playBeep(fallbackFreq, 120);
    try{
      if(elem.readyState >= 2){
        try{ elem.currentTime = 0; }catch(e){}
        const p = elem.play();
        if(p) await p.catch(async ()=>{ await playBeep(fallbackFreq,120); });
        return;
      } else {
        return playBeep(fallbackFreq,120);
      }
    }catch{
      return playBeep(fallbackFreq,120);
    }
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function startSequence(){
    if(running) return;
    running = true;
    stopRequested = false;
    startBtn.textContent = 'Stop';

    for(let t=5; t>0; t--){
      if(stopRequested) return reset();
      timerDisplay.textContent = t;
      await playBeep(700,80);
      await sleep(1000);
    }

    for(let rep=1; rep<=maxReps; rep++){
      if(stopRequested) return reset();
      repCounter.textContent = `Rep ${rep}`;

      document.body.style.backgroundColor = 'green';
      playSoundElemOrBeep(soundRedToGreenElem,1000);
      await runCountdownWithChecks(3);
      if(stopRequested) return reset();

      document.body.style.backgroundColor = 'red';
      playSoundElemOrBeep(soundGreenToRedElem,400);
      await runCountdownWithChecks(2);
    }

    reset();
  }

  async function runCountdownWithChecks(seconds){
    for(let t=seconds; t>0; t--){
      if(stopRequested) return;
      timerDisplay.textContent = t;
      await sleep(1000);
    }
  }

  function reset(){
    running = false;
    stopRequested = false;
    document.body.style.backgroundColor = 'white';
    timerDisplay.textContent = '';
    repCounter.textContent = '';
    startBtn.textContent = 'Start';
  }

  startBtn.addEventListener('click', async ()=>{
    if(!running){
      if(audioCtx && audioCtx.state==='suspended') await audioCtx.resume();
      startSequence();
    } else {
      stopRequested = true;
    }
  });

  function userGestureInit(){ ensureAudioContext(); window.removeEventListener('pointerdown', userGestureInit); }
  window.addEventListener('pointerdown', userGestureInit);

  startBtn.addEventListener('keydown', e=>{
    if(e.code==='Space' || e.code==='Enter'){ e.preventDefault(); startBtn.click(); }
  });
</script>
</body>
</html>
